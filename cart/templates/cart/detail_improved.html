{% extends "products/base.html" %}

{% block title %}Panier d'achat - Parfumerie Anas{% endblock %}

{% block content %}
    <h1 class="section-title">Panier d'achat</h1>
    
    {% if cart %}
        <div style="background-color: #111; border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
            <div class="cart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem;">
                <h2 style="color: #d4af37; margin: 0;">Vos articles (<span id="cart-count">{{ cart|length }}</span> article{{ cart|length|pluralize }})</h2>
                <form action="{% url 'cart:cart_clear' %}" method="post" style="display: inline;" id="clear-cart-form">
                    {% csrf_token %}
                    <button type="button" class="btn-clear" 
                            style="background-color: #ff6b6b; color: #fff; border: none; padding: 0.5rem 1rem; 
                                   border-radius: 3px; cursor: pointer; font-size: 0.9rem;"
                            onclick="clearCart()">
                        Vider le panier
                    </button>
                </form>
            </div>

            <div id="cart-items">
                {% for item in cart %}
                    <div class="cart-item" data-product-id="{{ item.product.id }}" 
                         style="display: flex; justify-content: space-between; align-items: center; 
                               border-bottom: 1px solid #333; padding: 1.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                     style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                            {% else %}
                                <div style="width: 100px; height: 100px; background-color: #333; 
                                           border-radius: 8px; display: flex; align-items: center; 
                                           justify-content: center; font-size: 0.8rem; text-align: center;">
                                    {{ item.product.name }}
                                </div>
                            {% endif %}
                            
                            <div style="flex: 1;">
                                <h3 style="color: #fff; margin-bottom: 0.5rem; font-size: 1.2rem;">
                                    <a href="{{ item.product.get_absolute_url }}" style="color: #fff; text-decoration: none;">
                                        {{ item.product.name }}
                                    </a>
                                </h3>
                                <p style="color: #ccc; margin-bottom: 0.5rem;">Prix unitaire: {{ item.price }} DH</p>
                                
                                <!-- Contr√¥les de quantit√© am√©lior√©s avec AJAX -->
                                <div class="quantity-controls" style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                                    <label for="quantity_{{ item.product.id }}" style="color: #ccc; font-weight: bold;">Quantit√©:</label>
                                    
                                    <div class="quantity-selector" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button type="button" class="quantity-btn" data-action="decrease" data-product-id="{{ item.product.id }}"
                                                style="background-color: #333; color: #fff; border: none; width: 30px; height: 30px; 
                                                       border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            -
                                        </button>
                                        
                                        <input type="number" name="quantity" id="quantity_{{ item.product.id }}" 
                                               value="{{ item.quantity }}" min="1" max="20"
                                               class="quantity-input" data-product-id="{{ item.product.id }}"
                                               style="background-color: #333; color: #fff; border: 1px solid #555; 
                                                      padding: 0.5rem; border-radius: 3px; width: 60px; text-align: center;">
                                        
                                        <button type="button" class="quantity-btn" data-action="increase" data-product-id="{{ item.product.id }}"
                                                style="background-color: #333; color: #fff; border: none; width: 30px; height: 30px; 
                                                       border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: right; min-width: 150px;">
                            <div class="item-total" id="item-total-{{ item.product.id }}" style="color: #d4af37; font-weight: bold; margin-bottom: 1rem; font-size: 1.3rem;">
                                {{ item.total_price }} DH
                            </div>
                            <button type="button" class="remove-btn" data-product-id="{{ item.product.id }}"
                                    style="background-color: #ff6b6b; color: #fff; border: none; padding: 0.5rem 1rem; 
                                           border-radius: 3px; cursor: pointer; font-size: 0.9rem;">
                                Supprimer
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div class="cart-summary" style="margin-top: 2rem; text-align: center; border-top: 1px solid #333; padding-top: 2rem;">
                <div class="total-price" style="font-size: 1.8rem; color: #d4af37; font-weight: bold; margin-bottom: 2rem;">
                    Total: <span id="cart-total">{{ cart.get_total_price }}</span> DH
                </div>
                
                <div class="cart-actions" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <a href="{% url 'orders:order_create' %}" class="btn checkout-btn" 
                       style="font-size: 1.2rem; padding: 1rem 2rem; background-color: #28a745; color: #fff;">
                        Finaliser la commande
                    </a>
                    <a href="{% url 'products:product_list' %}" class="btn continue-shopping-btn" 
                       style="background-color: #333; color: #fff; font-size: 1.2rem; padding: 1rem 2rem;">
                        Continuer les achats
                    </a>
                </div>
            </div>
        </div>
    {% else %}
        <div class="empty-cart" style="text-align: center; padding: 4rem; background-color: #111; border-radius: 10px;">
            <div style="font-size: 4rem; color: #333; margin-bottom: 1rem;">üõí</div>
            <h2 style="color: #ccc; margin-bottom: 1rem;">Votre panier est vide</h2>
            <p style="color: #999; margin-bottom: 2rem;">D√©couvrez nos parfums authentiques et ajoutez vos favoris au panier.</p>
            <a href="{% url 'products:product_list' %}" class="btn" style="font-size: 1.2rem; padding: 1rem 2rem;">
                D√©couvrir nos produits
            </a>
        </div>
    {% endif %}

    <script>
        // Fonction AJAX pour mettre √† jour la quantit√©
        function updateQuantityAjax(productId, newQuantity) {
            const formData = new FormData();
            formData.append('quantity', newQuantity);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch(`/cart/update/${productId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mettre √† jour l'interface
                    document.getElementById('cart-total').textContent = data.cart_total;
                    document.getElementById('cart-count').textContent = data.cart_count;
                    
                    const itemTotal = document.getElementById(`item-total-${productId}`);
                    if (itemTotal) {
                        itemTotal.textContent = data.item_total + ' DH';
                    }
                    
                    // Afficher la notification
                    notificationSystem.show(data.message, data.notification_type, 3000);
                    
                    // Si la quantit√© est 0, supprimer l'√©l√©ment
                    if (newQuantity === 0) {
                        const cartItem = document.querySelector(`[data-product-id="${productId}"]`);
                        if (cartItem) {
                            cartItem.style.transition = 'all 0.3s ease';
                            cartItem.style.opacity = '0';
                            cartItem.style.transform = 'translateX(-100%)';
                            setTimeout(() => {
                                cartItem.remove();
                                // V√©rifier si le panier est vide
                                if (data.cart_count === 0) {
                                    location.reload();
                                }
                            }, 300);
                        }
                    }
                } else {
                    // Afficher l'erreur
                    notificationSystem.show(data.message, data.notification_type || 'error', 4000);
                    
                    // Restaurer la valeur pr√©c√©dente
                    const input = document.getElementById(`quantity_${productId}`);
                    if (input) {
                        input.value = input.dataset.previousValue || 1;
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                notificationSystem.show('Erreur lors de la mise √† jour du panier', 'error', 4000);
            });
        }

        // Fonction pour supprimer un article
        function removeItem(productId) {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch(`/cart/remove/${productId}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('X-Notification-Message')) {
                    const message = response.headers.get('X-Notification-Message');
                    const type = response.headers.get('X-Notification-Type') || 'info';
                    notificationSystem.show(message, type, 3000);
                }
                
                // Animer la suppression
                const cartItem = document.querySelector(`[data-product-id="${productId}"]`);
                if (cartItem) {
                    cartItem.style.transition = 'all 0.3s ease';
                    cartItem.style.opacity = '0';
                    cartItem.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        location.reload(); // Recharger pour mettre √† jour les totaux
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                notificationSystem.show('Erreur lors de la suppression', 'error', 4000);
            });
        }

        // Fonction pour vider le panier
        function clearCart() {
            if (confirm('√ätes-vous s√ªr de vouloir vider compl√®tement le panier ?')) {
                const form = document.getElementById('clear-cart-form');
                
                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                })
                .then(response => {
                    if (response.headers.get('X-Notification-Message')) {
                        const message = response.headers.get('X-Notification-Message');
                        const type = response.headers.get('X-Notification-Type') || 'success';
                        notificationSystem.show(message, type, 3000);
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    notificationSystem.show('Erreur lors du vidage du panier', 'error', 4000);
                });
            }
        }

        // Gestion des √©v√©nements au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion des boutons de quantit√©
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.dataset.action;
                    const productId = this.dataset.productId;
                    const input = document.getElementById('quantity_' + productId);
                    let currentValue = parseInt(input.value);
                    let newValue = currentValue;
                    
                    // Sauvegarder la valeur pr√©c√©dente
                    input.dataset.previousValue = currentValue;
                    
                    if (action === 'increase' && currentValue < 20) {
                        newValue = currentValue + 1;
                        input.value = newValue;
                    } else if (action === 'decrease' && currentValue > 1) {
                        newValue = currentValue - 1;
                        input.value = newValue;
                    }
                    
                    // Mise √† jour AJAX si la valeur a chang√©
                    if (newValue !== currentValue) {
                        updateQuantityAjax(productId, newValue);
                    }
                });
            });
            
            // Mise √† jour lors de la saisie directe
            document.querySelectorAll('.quantity-input').forEach(input => {
                let timeoutId;
                
                input.addEventListener('input', function() {
                    const productId = this.dataset.productId;
                    let value = parseInt(this.value);
                    
                    // Sauvegarder la valeur pr√©c√©dente
                    this.dataset.previousValue = this.dataset.previousValue || value;
                    
                    // Validation
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    }
                    if (value > 20) {
                        this.value = 20;
                        value = 20;
                    }
                    
                    // Annuler le timeout pr√©c√©dent
                    clearTimeout(timeoutId);
                    
                    // Programmer la mise √† jour apr√®s 1 seconde d'inactivit√©
                    timeoutId = setTimeout(() => {
                        updateQuantityAjax(productId, value);
                    }, 1000);
                });
                
                // Mise √† jour imm√©diate lors de la perte de focus
                input.addEventListener('blur', function() {
                    const productId = this.dataset.productId;
                    let value = parseInt(this.value);
                    
                    // Validation
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    }
                    if (value > 20) {
                        this.value = 20;
                        value = 20;
                    }
                    
                    // Annuler le timeout et mettre √† jour imm√©diatement
                    clearTimeout(timeoutId);
                    updateQuantityAjax(productId, value);
                });
            });
            
            // Gestion des boutons de suppression
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    if (confirm('√ätes-vous s√ªr de vouloir supprimer cet article ?')) {
                        removeItem(productId);
                    }
                });
            });
        });
    </script>
{% endblock %}


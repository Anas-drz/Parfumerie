{% extends "customers/base_auth.html" %}

{% block title %}Créer un compte - Parfumerie Anas{% endblock %}

{% block auth_content %}
    <div class="auth-header">
        <h1 class="auth-title">Créer un compte</h1>
        <p class="auth-subtitle">Rejoignez-nous pour profiter de nos parfums authentiques</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="registerForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="error-message">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }} *</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}
                    <div class="field-error">{{ form.first_name.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }} *</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}
                    <div class="field-error">{{ form.last_name.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }} *</label>
            {{ form.username }}
            {% if form.username.errors %}
                <div class="field-error">{{ form.username.errors }}</div>
            {% endif %}
            <div id="username-feedback" class="help-text"></div>
        </div>

        <div class="form-group">
            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }} *</label>
            {{ form.email }}
            {% if form.email.errors %}
                <div class="field-error">{{ form.email.errors }}</div>
            {% endif %}
            <div id="email-feedback" class="help-text"></div>
        </div>

        <div class="form-group">
            <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }}</label>
            {{ form.phone_number }}
            {% if form.phone_number.errors %}
                <div class="field-error">{{ form.phone_number.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
            {{ form.address }}
            {% if form.address.errors %}
                <div class="field-error">{{ form.address.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.password1.id_for_label }}" class="form-label">{{ form.password1.label }} *</label>
            {{ form.password1 }}
            {% if form.password1.errors %}
                <div class="field-error">{{ form.password1.errors }}</div>
            {% endif %}
            {% if form.password1.help_text %}
                <div class="help-text">{{ form.password1.help_text }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }} *</label>
            {{ form.password2 }}
            {% if form.password2.errors %}
                <div class="field-error">{{ form.password2.errors }}</div>
            {% endif %}
        </div>

        <button type="submit" class="btn-auth">Créer mon compte</button>
    </form>

    <div class="auth-links">
        <p style="color: #ccc; margin-bottom: 1rem;">Vous avez déjà un compte ?</p>
        <a href="{% url 'customers:login' %}">Se connecter</a>
        <a href="{% url 'products:product_list' %}">Retour à l'accueil</a>
    </div>

    <script>
        // Validation en temps réel du nom d'utilisateur
        document.addEventListener('DOMContentLoaded', function() {
            const usernameField = document.getElementById('{{ form.username.id_for_label }}');
            const emailField = document.getElementById('{{ form.email.id_for_label }}');
            const usernameFeedback = document.getElementById('username-feedback');
            const emailFeedback = document.getElementById('email-feedback');
            
            let usernameTimeout;
            let emailTimeout;
            
            if (usernameField) {
                usernameField.addEventListener('input', function() {
                    clearTimeout(usernameTimeout);
                    const username = this.value.trim();
                    
                    if (username.length >= 3) {
                        usernameTimeout = setTimeout(() => {
                            fetch(`{% url 'customers:check_username' %}?username=${encodeURIComponent(username)}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.available) {
                                        usernameFeedback.textContent = '✓ Nom d\'utilisateur disponible';
                                        usernameFeedback.style.color = '#28a745';
                                    } else {
                                        usernameFeedback.textContent = '✗ Ce nom d\'utilisateur est déjà pris';
                                        usernameFeedback.style.color = '#dc3545';
                                    }
                                })
                                .catch(() => {
                                    usernameFeedback.textContent = '';
                                });
                        }, 500);
                    } else {
                        usernameFeedback.textContent = '';
                    }
                });
            }
            
            if (emailField) {
                emailField.addEventListener('input', function() {
                    clearTimeout(emailTimeout);
                    const email = this.value.trim();
                    
                    if (email.includes('@') && email.includes('.')) {
                        emailTimeout = setTimeout(() => {
                            fetch(`{% url 'customers:check_email' %}?email=${encodeURIComponent(email)}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.available) {
                                        emailFeedback.textContent = '✓ Adresse email disponible';
                                        emailFeedback.style.color = '#28a745';
                                    } else {
                                        emailFeedback.textContent = '✗ Cette adresse email est déjà utilisée';
                                        emailFeedback.style.color = '#dc3545';
                                    }
                                })
                                .catch(() => {
                                    emailFeedback.textContent = '';
                                });
                        }, 500);
                    } else {
                        emailFeedback.textContent = '';
                    }
                });
            }
        });
    </script>
{% endblock %}

